rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to check user roles
    // Supports both new roles array and legacy role field for backward compatibility
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getRoles(userData) {
      return userData.get('roles', []);
    }

    function isAdmin(userData) {
      let roles = getRoles(userData);
      return 'admin' in roles || userData.get('role', '') == 'admin';
    }

    function isSeller(userData) {
      let roles = getRoles(userData);
      return 'seller' in roles || userData.get('role', '') == 'seller';
    }

    function isBuyer(userData) {
      let roles = getRoles(userData);
      return 'buyer' in roles || userData.get('role', '') == 'buyer';
    }

    // Users
    match /users/{userId} {
      allow create: if request.auth != null;

      // Authenticated users can read their own profile
      // OR any seller profile (for checkout GCash details)
      // OR admins can read all user profiles
      // BUT cannot read deleted users (unless own or admin)
      allow read: if (request.auth != null && request.auth.uid == userId)
              || (request.auth != null && ('seller' in resource.data.get('roles', []) || resource.data.get('role', '') == 'seller') && resource.data.get('accountStatus', 'active') != 'deleted')
              || (request.auth != null && isAdmin(getUserData()));

      // Only authenticated users can list users, admins can list all
      allow list: if request.auth != null;

      // A user can update their own profile fields, gcash details, recovery codes, password hash, and shop profile
      allow update: if request.auth != null && request.auth.uid == userId && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fullName', 'email', 'gcashName', 'gcashNumber', 'currentPassword', 'recoveryCodes', 'recoveryCodesUpdatedAt', 'lastPasswordRecovery', 'resetPassword', 'contactNumber', 'streetAddress', 'barangay', 'city', 'postalCode', 'country', 'passwordHash', 'updatedAt', 'shopName', 'shopAddress', 'shopBarangay', 'shopCity', 'allowShipping', 'allowPickup']);

      // Notifications Subcollection
      match /notifications/{notificationId} {
        allow read, list, update, delete: if request.auth.uid == userId;
        allow create: if request.auth != null;
      }

      // Favorites Subcollection
      match /favorites/{productId} {
        allow read, list, create, delete: if request.auth.uid == userId;
        allow update: if false;
      }
    }

    // Products
    match /products/{productId} {
      allow read, list: if true;
      allow create: if request.auth != null;

      // Sellers can update their own products
      // Buyers can decrement stock when placing an order
      // Admins can update products
      allow update: if (request.auth != null && resource.data.createdBy == request.auth.uid)
                    || (
                        request.auth != null &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stock']) &&
                        request.resource.data.stock >= 0 &&
                        request.resource.data.stock < resource.data.stock
                    )
                    || (request.auth != null && isAdmin(getUserData()));

      allow delete: if request.auth != null && (resource.data.createdBy == request.auth.uid || isAdmin(getUserData()));

      // Reviews Subcollection
      match /reviews/{userId} {
        allow read, list: if true;
        allow create: if request.auth != null
                      && request.auth.uid == userId
                      && !exists(/databases/$(database)/documents/products/$(productId)/reviews/$(userId));
        allow update, delete: if request.auth != null && request.auth.uid == userId;
      }
    }

    // Orders
    match /orders/{orderId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.buyerId;
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.buyerId
        || (resource.data.sellerIds != null && request.auth.uid in resource.data.sellerIds)
        || isAdmin(getUserData())
      );
      allow list: if request.auth != null && (
        // Admin can list all orders
        isAdmin(getUserData())
        // Buyer can only list their own orders
        || request.auth.uid == resource.data.buyerId
        // Seller can only list orders containing their products
        || (resource.data.sellerIds != null && request.auth.uid in resource.data.sellerIds)
      );

      // Sellers, buyers, and admins can update orders
      allow update: if request.auth != null && (
                      // Buyer can upload receipt image
                      (request.auth.uid == resource.data.buyerId
                      && request.resource.data.receiptImageUrl != null
                      && resource.data.receiptImageUrl == null
                      && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['receiptImageUrl']))
                      // Seller can update order/payment status ONLY if they have items in this order
                      || (resource.data.sellerIds != null
                          && request.auth.uid in resource.data.sellerIds
                          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['orderStatus', 'paymentStatus']))
                      || (isAdmin(getUserData()))
                    );
    }

    // Seller Applications
    match /seller-applications/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin(getUserData()));
      allow list: if request.auth != null && isAdmin(getUserData());
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin(getUserData()));
    }

    // Admin Logs
    match /admin-logs/{logId} {
      allow read, list, create: if request.auth != null;
      allow update, delete: if false;
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Product images uploaded by sellers
    match /products/{sellerUid}/{imagePath=**} {
      allow read: if true;
      allow write: if request.auth != null
                    && request.auth.uid == sellerUid
                    && request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*');
    }

    // Payment receipts from orders
    match /receipts/{orderId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null
                    && request.resource.size < 5 * 1024 * 1024
                    && request.resource.contentType.matches('image/.*');
    }
  }
}
